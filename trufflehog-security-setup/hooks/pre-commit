#!/bin/bash
#
# TruffleHog pre-commit hook
# Prevents committing secrets by scanning staged changes

# Check if TruffleHog is installed
if ! command -v trufflehog &> /dev/null; then
    echo "‚ö†Ô∏è  TruffleHog not found. Secret scanning will be skipped."
    echo "Please install TruffleHog for secret scanning:"
    echo "curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin"
    exit 0
fi

echo "üîç Scanning for secrets in staged changes..."

# Get list of staged files
staged_files=$(git diff --cached --name-only)

if [ -z "$staged_files" ]; then
    echo "No staged changes found. Nothing to scan."
    exit 0
fi

# Create temporary file with list of staged files
tmp_file=$(mktemp)
echo "$staged_files" > "$tmp_file"

# Scan only staged files
trufflehog filesystem \
    --no-update \
    --exclude-paths .git \
    --only-verified \
    --json \
    --include-paths "$tmp_file" \
    . > /tmp/trufflehog-pre-commit.json

# Check if any secrets were found
if [ -s /tmp/trufflehog-pre-commit.json ]; then
    echo "‚ùå ERROR: Potential secrets found in your staged changes!"
    echo "Please remove these secrets before committing."
    echo ""
    echo "Findings:"
    cat /tmp/trufflehog-pre-commit.json | jq -r '.[] | "- \(.DetectorType) in \(.SourceMetadata.Data.Filesystem.file) (Line \(.SourceMetadata.Data.Filesystem.line_number))"'
    
    # Clean up
    rm "$tmp_file"
    rm /tmp/trufflehog-pre-commit.json
    
    exit 1
else
    echo "‚úÖ No secrets found in staged changes!"
    
    # Clean up
    rm "$tmp_file"
    rm -f /tmp/trufflehog-pre-commit.json
    
    exit 0
fi
