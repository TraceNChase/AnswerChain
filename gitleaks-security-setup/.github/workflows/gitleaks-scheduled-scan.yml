name: Gitleaks Scheduled Scan

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:

jobs:
  scan:
    name: Full Repository Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all commits

      - name: Install Gitleaks
        run: |
          curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sh -s -- -b /usr/local/bin
          gitleaks version

      - name: Run comprehensive scan
        id: scan
        run: |
          mkdir -p gitleaks-results
          
          # Run full repository scan with multiple output formats
          gitleaks detect \
            --source=. \
            --config=gitleaks-security-setup/configs/gitleaks.toml \
            --report-format=json \
            --report-path=gitleaks-results/full-scan.json \
            --verbose
          
          # Also save SARIF format
          gitleaks detect \
            --source=. \
            --config=gitleaks-security-setup/configs/gitleaks.toml \
            --report-format=sarif \
            --report-path=gitleaks-results/full-scan.sarif \
            --verbose
          
          # Check if any secrets were found
          if [ -s gitleaks-results/full-scan.json ]; then
            FINDINGS=$(jq '. | length' gitleaks-results/full-scan.json)
            echo "SECRETS_FOUND=true" >> $GITHUB_OUTPUT
            echo "FINDINGS_COUNT=$FINDINGS" >> $GITHUB_OUTPUT
            
            # Generate HTML report
            echo "<html><head><title>Gitleaks Secret Scan Results</title>" > gitleaks-results/report.html
            echo "<style>body{font-family:sans-serif;max-width:1200px;margin:0 auto;padding:20px}h1{color:#d9534f}table{width:100%;border-collapse:collapse}th{background:#f8f9fa;text-align:left;padding:8px}td{padding:8px;border-top:1px solid #dee2e6}tr:nth-child(even){background:#f8f9fa}.secret{color:#d9534f;font-weight:bold}</style>" >> gitleaks-results/report.html
            echo "</head><body>" >> gitleaks-results/report.html
            echo "<h1>Gitleaks Secret Scan Results</h1>" >> gitleaks-results/report.html
            echo "<p>Scan date: $(date)</p>" >> gitleaks-results/report.html
            echo "<p>Total findings: $FINDINGS</p>" >> gitleaks-results/report.html
            echo "<table><thead><tr><th>Rule</th><th>File</th><th>Line</th><th>Commit</th><th>Author</th></tr></thead><tbody>" >> gitleaks-results/report.html
            
            jq -r '.[] | "<tr><td class=\"secret\">\(.RuleID)</td><td>\(.File)</td><td>\(.StartLine)-\(.EndLine)</td><td>\(.Commit)</td><td>\(.Author)</td></tr>"' gitleaks-results/full-scan.json >> gitleaks-results/report.html
            
            echo "</tbody></table></body></html>" >> gitleaks-results/report.html
          else
            echo "SECRETS_FOUND=false" >> $GITHUB_OUTPUT
            echo "FINDINGS_COUNT=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: steps.scan.outputs.SECRETS_FOUND == 'true'
        with:
          sarif_file: gitleaks-results/full-scan.sarif
          category: gitleaks-scheduled

      - name: Upload HTML report
        uses: actions/upload-artifact@v3
        if: steps.scan.outputs.SECRETS_FOUND == 'true'
        with:
          name: gitleaks-secret-report
          path: gitleaks-results/report.html
          retention-days: 90

      - name: Create issue if secrets found
        uses: actions/github-script@v6
        if: steps.scan.outputs.SECRETS_FOUND == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const findingsCount = process.env.FINDINGS_COUNT;
            const issueTitle = `ðŸš¨ Gitleaks detected ${findingsCount} potential secrets`;
            
            let issueBody = `## Gitleaks Secret Scan Results\n\n`;
            issueBody += `The scheduled Gitleaks scan has detected ${findingsCount} potential secrets in the repository.\n\n`;
            issueBody += `### Next Steps\n\n`;
            issueBody += `1. Download the HTML report from the GitHub Actions artifacts\n`;
            issueBody += `2. Review each finding to confirm if it's an actual secret\n`;
            issueBody += `3. Remove any genuine secrets from the repository\n`;
            issueBody += `4. Rotate any exposed credentials immediately\n`;
            issueBody += `5. Consider updating the Gitleaks configuration to reduce false positives\n\n`;
            issueBody += `> View the full scan details in the [Actions tab](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            // Create the issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'secret-exposure']
            });
