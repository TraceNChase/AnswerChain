#!/bin/bash
#
# Gitleaks pre-commit hook
# Prevents committing secrets by scanning staged changes

# Check if Gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo "‚ö†Ô∏è  Gitleaks not found. Secret scanning will be skipped."
    echo "Please install Gitleaks for secret scanning:"
    echo "curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sh -s -- -b /usr/local/bin"
    exit 0
fi

echo "üîç Scanning for secrets in staged changes..."

# Get list of staged files
staged_files=$(git diff --cached --name-only)

if [ -z "$staged_files" ]; then
    echo "No staged changes found. Nothing to scan."
    exit 0
fi

# Create temporary file with list of staged files
tmp_file=$(mktemp)
echo "$staged_files" > "$tmp_file"

# Initialize empty results file
echo "[]" > /tmp/gitleaks-pre-commit.json

# Scan each staged file
any_secrets_found=false
for file in $staged_files; do
    if [ -f "$file" ]; then
        gitleaks detect \
            --source="$file" \
            --config=gitleaks-security-setup/configs/gitleaks.toml \
            --report-format=json \
            --report-path=/tmp/gitleaks-pre-commit-temp.json \
            --no-git \
            --verbose > /dev/null 2>&1
        
        # If there are findings, append them to the main results
        if [ -s /tmp/gitleaks-pre-commit-temp.json ]; then
            any_secrets_found=true
            # Merge the JSON files
            jq -s 'add' /tmp/gitleaks-pre-commit.json /tmp/gitleaks-pre-commit-temp.json > /tmp/gitleaks-pre-commit-merged.json
            mv /tmp/gitleaks-pre-commit-merged.json /tmp/gitleaks-pre-commit.json
        fi
    fi
done

# Check if any secrets were found
if [ "$any_secrets_found" = true ]; then
    echo "‚ùå ERROR: Potential secrets found in your staged changes!"
    echo "Please remove these secrets before committing."
    echo ""
    echo "Findings:"
    jq -r '.[] | "- \(.RuleID) in \(.File) (Line \(.StartLine))"' /tmp/gitleaks-pre-commit.json
    
    # Clean up
    rm "$tmp_file"
    rm /tmp/gitleaks-pre-commit*.json
    
    exit 1
else
    echo "‚úÖ No secrets found in staged changes!"
    
    # Clean up
    rm "$tmp_file"
    rm -f /tmp/gitleaks-pre-commit*.json
    
    exit 0
fi
